<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî Fresh Systems</title>

<link rel="stylesheet" href="styles.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap&subset=cyrillic" rel="stylesheet"/>

<style>
:root{
  --ink:#eaf6ff; --muted:#bcd2e7;
  --panel:rgba(255,255,255,.07); --panel-br:rgba(255,255,255,.14);
  --cyan:#7dd3fc; --good:#8cf9cc;
  --pipeGlow: rgba(170,235,255,.9);
}
*{box-sizing:border-box}
body{overflow-x:hidden;}

/* –≤–µ—Ä—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.page-tech{position:relative; z-index:1; padding-top:84px}
.container{max-width:1100px; margin:0 auto; padding:0 20px}
.h1{font:900 clamp(30px,6vw,56px)/1.05 Inter,system-ui; color:var(--ink); margin:0 0 8px}
.lead{color:var(--muted); font-size:clamp(14px,2.3vw,18px); margin:0 0 16px}

/* ====== –°–¶–ï–ù–ê –ü–ï–†–ï–õ–Å–¢–û–í ====== */
.flow-scene{
  position:relative;
  scroll-snap-type:y mandatory;       /* —Ñ–∏–∫—Å–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º ‚Äú—Å–ª–∞–π–¥–µ‚Äù */
}
.stage{
  position:relative;
  height:100vh;
  min-height:640px;
  scroll-snap-align:start;            /* –ø—Ä–∏–ª–∏–ø–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Å–µ–∫—Ü–∏–∏ –∫ –≤–µ—Ä—Ö—É */
  display:grid;
  grid-template-columns: 1fr min(560px,60vw) 1fr; /* –ª–µ–≤–æ ‚Äî —Ç—Ä—É–±–∞ ‚Äî –ø—Ä–∞–≤–æ */
  align-items:center;
  padding:18px 20px;
}
@media (max-width:900px){
  .stage{grid-template-columns: 1fr min(520px,72vw) 1fr}
}
@media (max-width:760px){
  .stage{grid-template-columns: 1fr; padding:14px}
}

/* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π —Ç—Ä—É–±—ã ‚Äî –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –∏ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –∫–∞–∂–¥–æ–º —Å–ª–∞–π–¥–µ */
.pipe-layer{
  position:fixed; inset:0; z-index:-1; pointer-events:none;
}
.pipe-wrap{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  transition: transform .8s cubic-bezier(.22,.61,.36,1); /* –ª—ë–≥–∫–∏–π –ø–æ–≤–æ—Ä–æ—Ç */
  will-change: transform;
}
#pipeSVG{width:min(560px,60vw); height:86vh; display:block; filter:drop-shadow(0 20px 40px rgba(0,0,0,.35))}
@media (max-width:760px){ #pipeSVG{width:min(520px,82vw); height:78vh} }

/* –°–ª–æ–∏ —Ç—Ä—É–±—ã */
.pipe-shadow{stroke:rgba(0,0,0,.42); stroke-width:36; fill:none; stroke-linecap:round; filter:url(#shadowSoft)}
.pipe-glass {stroke:url(#glassStroke); stroke-width:32; fill:none; stroke-linecap:round; filter:url(#specLight)}
.pipe-core  {stroke:url(#coreGrad);   stroke-width:18; fill:none; stroke-linecap:round; filter:drop-shadow(0 0 10px rgba(116,210,255,.55))}
.pipe-flow  {stroke:var(--pipeGlow);  stroke-width:6; fill:none; stroke-linecap:round; stroke-dasharray:0 20 8 106; animation:flow 3s linear infinite; opacity:.95}
@keyframes flow{to{stroke-dashoffset:-150}}

/* –ú–∞—Å–∫–∞, —á—Ç–æ–±—ã –∫–∞–ø–ª—è –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∞ –∑–∞ —Ç—Ä—É–±—É */
.mask-stroke{stroke:#fff; stroke-width:24; fill:none; stroke-linecap:round}

/* –ö–∞–ø–ª—è ‚Äî –æ–¥–Ω–∞, —Å–∏–Ω—Ö—Ä–æ–Ω —Å –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –º–µ–∂–¥—É —Å—Ç–∞–¥–∏—è–º–∏ */
.drop{filter:drop-shadow(0 0 16px rgba(116,210,255,1))}
.drop .aura{fill:rgba(115,220,255,.40); transform-origin:center; animation:pulse 1.8s ease-in-out infinite}
.drop .body{fill:url(#dropGrad); stroke:#e6fbff; stroke-width:1.25}
.drop .glint{fill:#fff; opacity:.95}
@keyframes pulse{0%,100%{transform:scale(.92); opacity:.65} 50%{transform:scale(1.07); opacity:1}}

/* –£–∑–µ–ª (–∏–∫–æ–Ω–∫–∞) ‚Äî –≤ —Å–∞–º–æ–π —Ç—Ä—É–±–µ */
.module .plate{fill:rgba(9,14,22,.85); stroke:rgba(170,215,255,.65); stroke-width:1.8; rx:10}
.module .icon{stroke:#e0f5ff; stroke-width:2.3; fill:none; stroke-linecap:round; stroke-linejoin:round}
.module.active .plate{stroke:var(--good)}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–ø—Ä–∞–≤–∞/—Å–ª–µ–≤–∞ –æ—Ç —Ç—Ä—É–±—ã (–≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏) */
.card{
  background:var(--panel);
  border:1px solid var(--panel-br);
  border-radius:16px;
  padding:14px 16px;
  color:#e9f6ff;
  backdrop-filter:blur(10px);
  box-shadow:0 18px 42px rgba(0,0,0,.32);
  max-width:460px;
  opacity:0; transform:translateY(14px);
  transition:.55s ease;
}
.card.show{opacity:1; transform:none}
.card .tag{display:inline-flex; gap:8px; align-items:center; padding:4px 10px; border-radius:999px;
  border:1px solid rgba(125,211,252,.35); background:rgba(125,211,252,.14); color:#dff6ff; font-weight:700; margin-bottom:8px}
.card h3{margin:4px 0 8px; font:700 18px/1.3 Inter; color:#eef9ff}
.card p{margin:0; color:#cfe3f5; font-size:15px; line-height:1.6}
.stage-left{grid-column:1; justify-self:end; margin-right: min(3vw,24px)}
.stage-right{grid-column:3; justify-self:start; margin-left: min(3vw,24px)}
@media (max-width:760px){
  .stage-left,.stage-right{grid-column:1; justify-self:center; margin:0; max-width:680px; width:100%}
}

/* –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ —Å–ª–µ–≤–∞ */
.mini{
  position:fixed; left:16px; top:104px; width:220px; z-index:3;
  background:var(--panel); border:1px solid var(--panel-br); border-radius:14px; padding:10px; backdrop-filter:blur(8px)
}
.mini h4{margin:4px 8px 8px; font:700 12px/1 Inter; color:#a9defc; letter-spacing:.1em; text-transform:uppercase}
.mini a{display:flex; gap:8px; align-items:center; padding:8px 10px; border-radius:10px; color:#e6f3ff; font-weight:600; text-decoration:none}
.mini a .dot{width:8px; height:8px; border-radius:50%; background:var(--cyan); box-shadow:0 0 8px var(--cyan)}
.mini a.active{background:rgba(56,189,248,.14)}
@media (max-width:1000px){ .mini{display:none} }

/* –£–≤–∞–∂–µ–Ω–∏–µ –∫ prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  .pipe-flow{animation:none}
  .drop .aura{animation:none}
  .card{transition:none}
}

/* –§–æ–Ω-–≤–∏–¥–µ–æ –∏ –æ–≤–µ—Ä–ª–µ–π —É–∂–µ —Ç—è–Ω—É—Ç—Å—è –∏–∑ styles.css –ø—Ä–æ–µ–∫—Ç–∞ */
</style>
</head>
<body>
<!-- –≤–∏–¥–µ–æ-—Ñ–æ–Ω –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ -->
<video class="bg-video" autoplay muted loop playsinline poster="images/hero-water.jpg">
  <source src="images/water-bg.mp4" type="video/mp4"/>
</video>
<div class="overlay"></div>

<header class="site-header">
  <a class="brand" href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é">FS</a>
  <nav class="top-nav" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é">
    <a href="technologies.html" class="active">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a>
    <a href="sanpin.html">–°–∞–Ω–ü–∏–ù</a>
    <a href="taste.html">–ü–æ—á–µ–º—É –≤–æ–¥–∞ –≤–∫—É—Å–Ω–∞—è</a>
    <a href="services.html">–£—Å–ª—É–≥–∏</a>
    <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
  </nav>
  <button class="menu-toggle" id="menuBtn" aria-label="–ú–µ–Ω—é" aria-expanded="false"><span></span></button>
</header>
<nav class="mobile-drawer" id="drawer" hidden aria-label="–ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é">
  <a href="technologies.html" class="active">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a>
  <a href="sanpin.html">–°–∞–Ω–ü–∏–ù</a>
  <a href="taste.html">–ü–æ—á–µ–º—É –≤–æ–¥–∞ –≤–∫—É—Å–Ω–∞—è</a>
  <a href="services.html">–£—Å–ª—É–≥–∏</a>
  <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
</nav>

<!-- –ú–∏–Ω–∏–∫–∞—Ä—Ç–∞ -->
<aside class="mini" id="miniMap" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º">
  <h4>–°—Ç–∞–¥–∏–∏</h4>
  <nav id="miniNav"></nav>
</aside>

<main class="page-tech container">
  <h1 class="h1">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h1>
  <p class="lead">–ö–∞–∂–¥—ã–π —ç–∫—Ä–∞–Ω ‚Äî –æ–¥–Ω–∞ —Å—Ç–∞–¥–∏—è. –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–π: –∫–∞–ø–ª—è –¥–≤–∏–∂–µ—Ç—Å—è –ø–æ —Ç—Ä—É–±–µ, –∫–∞—Ä—Ç–æ—á–∫–∞ –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω—è–µ—Ç —Å–º—ã—Å–ª —É–∑–ª–∞. –ù–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ.</p>
</main>

<!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–π —Ç—Ä—É–±—ã -->
<div class="pipe-layer" aria-hidden="true">
  <div class="pipe-wrap" id="pipeWrap">
    <svg id="pipeSVG" viewBox="0 0 560 1200" preserveAspectRatio="none" role="img" aria-label="–¢—Ä—É–±–∞">
      <defs>
        <linearGradient id="glassStroke" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%"   stop-color="rgba(240,248,255,.75)"/>
          <stop offset="50%"  stop-color="rgba(170,205,235,.38)"/>
          <stop offset="100%" stop-color="rgba(40,60,80,.36)"/>
        </linearGradient>
        <linearGradient id="coreGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%"   stop-color="rgba(230,255,255,.98)"/>
          <stop offset="70%"  stop-color="rgba(116,210,255,.78)"/>
          <stop offset="100%" stop-color="rgba(116,210,255,.48)"/>
        </linearGradient>
        <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
          <stop offset="0%"   stop-color="#ffffff"/>
          <stop offset="55%"  stop-color="#eaffff"/>
          <stop offset="100%" stop-color="#7dd3fc"/>
        </radialGradient>
        <filter id="shadowSoft" x="-30%" y="-30%" width="160%" height="160%"><feGaussianBlur stdDeviation="3"/></filter>
        <filter id="specLight" x="-20%" y="-20%" width="140%" height="140%">
          <feSpecularLighting surfaceScale="2.2" specularConstant="0.6" specularExponent="18" lighting-color="#e6f7ff">
            <fePointLight x="-120" y="-200" z="100"/>
          </feSpecularLighting>
          <feComposite operator="in" in2="SourceGraphic"/>
        </filter>
        <mask id="tubeMask">
          <rect x="0" y="0" width="560" height="1200" fill="black"/>
          <path id="maskPath" class="mask-stroke" d=""/>
        </mask>
      </defs>

      <!-- –ø—É—Ç—å —Ç—Ä—É–±—ã ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å —Å –ª—ë–≥–∫–∏–º–∏ S-–∏–∑–≥–∏–±–∞–º–∏ -->
      <path id="pipeShadow" class="pipe-shadow" d=""/>
      <path id="pipeGlass"  class="pipe-glass"  d=""/>
      <path id="pipeCore"   class="pipe-core"   d=""/>
      <path id="pipeFlow"   class="pipe-flow"   d="" mask="url(#tubeMask)"/>

      <!-- —É–∑–ª—ã (–∏–∫–æ–Ω–∫–∏) -->
      <g id="modules"></g>

      <!-- –æ–¥–Ω–∞ –∫–∞–ø–ª—è -->
      <g id="drop" class="drop" transform="translate(280,100)" mask="url(#tubeMask)">
        <ellipse class="aura" cx="0" cy="0" rx="20" ry="26"/>
        <ellipse class="body" cx="0" cy="0" rx="13" ry="18"/>
        <circle class="glint" cx="3" cy="-7" r="3.2"/>
      </g>
    </svg>
  </div>
</div>

<!-- –°—Ü–µ–Ω–∞ –∏–∑ ‚Äú—Å–ª–∞–π–¥–æ–≤‚Äù -->
<section class="flow-scene" id="flow">
  <!-- —Å–µ–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—ë–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JS, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –∏ –º–∏–Ω–∏–∫–∞—Ä—Ç—É –¥–µ—Ä–∂–∞—Ç—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ -->
</section>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="minor">¬© 2025 Fresh Systems</div>
    <a href="index.html" class="minor">–ì–ª–∞–≤–Ω–∞—è</a>
  </div>
</footer>

<script>
/* –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
(()=>{const b=document.getElementById('menuBtn'),d=document.getElementById('drawer');if(!b||!d)return;
const t=o=>{if(o===undefined)o=!d.classList.contains('open');d.classList.toggle('open',o);d.hidden=!o;b.setAttribute('aria-expanded',String(o));document.body.classList.toggle('mobile-menu-open',o)};
const h=e=>{e.preventDefault();t()};b.addEventListener('click',h,{passive:false});b.addEventListener('touchstart',h,{passive:false});
document.addEventListener('click',e=>{if(!d.classList.contains('open'))return;if(!d.contains(e.target)&&!b.contains(e.target))t(false);});})();

/* ===== –î–ê–ù–ù–´–ï –°–¢–ê–î–ò–ô (–ø–æ—Ä—è–¥–æ–∫ = –ø–æ—Ä—è–¥–æ–∫ ‚Äú—Å–ª–∞–π–¥–æ–≤‚Äù) ===== */
const STAGES = [
  {id:'hvs', tag:'–•–í–°', title:'–í–≤–æ–¥ —Ö–æ–ª–æ–¥–Ω–æ–π –≤–æ–¥—ã', text:'–ò—Å—Ö–æ–¥–Ω–∞—è –≤–æ–¥–∞ –Ω–∞ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É.'},
  {id:'f1',  tag:'F1',  title:'–ì—Ä—É–±–∞—è –æ—á–∏—Å—Ç–∫–∞ 100 Œºm', text:'–£–±–∏—Ä–∞–µ—Ç –ø–µ—Å–æ–∫ –∏ —Ä–∂–∞–≤—á–∏–Ω—É. –ü—Ä–æ–º—ã–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä.', icon:'grid'},
  {id:'f2',  tag:'F2',  title:'–¢–æ–Ω–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ 5 Œºm',  text:'–ö–∞—Ä—Ç—Ä–∏–¥–∂ PP: –º–µ–ª–∫–∏–µ –≤–∑–≤–µ—Å–∏.', icon:'cartridge'},
  {id:'f3',  tag:'F3',  title:'–£–≥–æ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä',      text:'–ê–¥—Å–æ—Ä–±—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∫–∏, –∑–∞–ø–∞—Ö–æ–≤, —Ö–ª–æ—Ä–ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö.', icon:'carbon'},
  {id:'hd',  tag:'HD',  title:'–ù–∞—Å–æ—Å –≤—ã—Å–æ–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è', text:'–°–æ–∑–¥–∞—ë—Ç –¥–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞.', icon:'pump'},
  {id:'as',  tag:'AS',  title:'–ê–Ω—Ç–∏—Å–∏–ª–∞–Ω—Ç (–æ–ø—Ü.)',    text:'–ó–∞—â–∏—â–∞–µ—Ç –º–µ–º–±—Ä–∞–Ω—É –æ—Ç –æ—Ç–ª–æ–∂–µ–Ω–∏–π.', icon:'dose'},
  {id:'nf',  tag:'NF',  title:'–ù–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è',       text:'–ú–µ–º–±—Ä–∞–Ω–∞: –ø–µ—Ä–º–µ–∞—Ç ‚Äî –≤ –ø–∏—Ç—å–µ–≤—É—é –∑–æ–Ω—É, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç ‚Äî –≤ –¥—Ä–µ–Ω–∞–∂.', icon:'membrane'},
  {id:'min', tag:'MIN', title:'–ú–∏–Ω–µ—Ä–∞–ª–∏–∑–∞—Ç–æ—Ä Ca/Mg',  text:'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∫—É—Å: Ca/Mg –¥–æ —Ü–µ–ª–µ–≤–æ–≥–æ TDS.', icon:'min'},
  {id:'uv',  tag:'UV',  title:'–£–§-–æ–±–µ–∑–∑–∞—Ä–∞–∂–∏–≤–∞–Ω–∏–µ',   text:'–§–∏–Ω–∏—à–Ω–∞—è –±–∏–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–°–∞–Ω–ü–∏–ù).', icon:'uv'},
  {id:'tap', tag:'üíß',  title:'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å',          text:'–ö—Ä–∞–Ω ‚Üí —Å—Ç–∞–∫–∞–Ω —Å —á–∏—Å—Ç–æ–π –≤–æ–¥–æ–π.', icon:'tap', final:true}
];

/* ===== DOM ===== */
const flow    = document.getElementById('flow');
const miniNav = document.getElementById('miniNav');
const pipeWrap= document.getElementById('pipeWrap');

const svg      = document.getElementById('pipeSVG');
const pShadow  = document.getElementById('pipeShadow');
const pGlass   = document.getElementById('pipeGlass');
const pCore    = document.getElementById('pipeCore');
const pFlow    = document.getElementById('pipeFlow');
const maskPath = document.getElementById('maskPath');
const gMods    = document.getElementById('modules');
const drop     = document.getElementById('drop');

let coreLen = 0;
let points  = [];           // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∑–ª–æ–≤ –Ω–∞ —Ç—Ä—É–±–µ (–≤–Ω—É—Ç—Ä–∏ SVG)
let sections= [];           // DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Å–µ–∫—Ü–∏–π
let ioCards;

/* ===== –ò–ö–û–ù–ö–ò –£–ó–õ–û–í ===== */
function icon(kind){
  switch(kind){
    case 'grid':      return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><path class="icon" d="M-34 -10 h68 v20 h-68 z M-17 -10 v20 M17 -10 v20 M-34 0 h68"/>`;
    case 'cartridge': return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><ellipse class="icon" cx="0" cy="0" rx="28" ry="12"/>`;
    case 'carbon':    return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><rect class="icon" x="-28" y="-10" width="56" height="20" rx="6"/>`;
    case 'pump':      return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><rect class="icon" x="-18" y="-8" width="22" height="16" rx="3"/><rect class="icon" x="8" y="-6" width="16" height="12" rx="3"/>`;
    case 'dose':      return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><path class="icon" d="M-8 -12 v24 M8 -12 v24 M-18 0 h36"/>`;
    case 'membrane':  return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><path class="icon" d="M-28 -8 h56 M-28 -2 h56 M-28 4 h56"/>`;
    case 'min':       return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><rect class="icon" x="-12" y="-8" width="24" height="16" rx="3"/>`;
    case 'uv':        return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><path class="icon" d="M-26 0 h52 M-14 -8 h28 M-14 8 h28"/>`;
    case 'tap':       return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/><path class="icon" d="M-16 0 h32 M12 0 v12 M0 14 v-8"/>`;
    default:          return `<rect class="plate" x="-44" y="-18" width="88" height="36" rx="10"/>`;
  }
}

/* ===== –°–¢–†–û–ò–ú –¢–†–£–ë–£ (–≤—ã—Å–æ—Ç–∞ –ø–æ–¥ –≤—å—é–ø–æ—Ä—Ç), —Ç–æ—á–∫–∏ —É–∑–ª–æ–≤, –∏–∫–æ–Ω–∫–∏ ===== */
function buildPipe(){
  const VBW=560, VBH=1200;
  const cx=VBW/2, top=80, bottom=VBH-80;

  // —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —É–∑–ª—ã –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
  const y = STAGES.map((_,i)=> top + (i/(STAGES.length-1))*(bottom-top) );
  // –ª—ë–≥–∫–∏–µ S-—Å–º–µ—â–µ–Ω–∏—è –ø–æ X –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
  const xOffset = (i)=> (i%2? 18 : -18);

  // –∫—Ä–∏–≤–∞—è, –ø—Ä–æ—Ö–æ–¥—è—â–∞—è —á–µ—Ä–µ–∑ –≤—Å–µ —Ç–æ—á–∫–∏
  let d = `M ${cx} ${y[0]}`;
  for(let i=1;i<y.length;i++){
    const x1=cx+xOffset(i-1), x2=cx+xOffset(i);
    const ym=(y[i-1]+y[i])/2;
    d+=` C ${x1} ${ym}, ${x2} ${ym}, ${cx} ${y[i]}`;
  }
  [pShadow,pGlass,pCore,pFlow,maskPath].forEach(p=>p.setAttribute('d', d));
  coreLen = pCore.getTotalLength();

  // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∑–ª–æ–≤ –Ω–∞ –ø—É—Ç–∏
  points = y.map(yy=>{
    // –Ω–∞–π–¥—ë–º –¥–ª–∏–Ω—É –Ω–∞ –∫—Ä–∏–≤–æ–π, –±–ª–∏–∑–∫—É—é –∫ —ç—Ç–æ–º—É y
    // –≥—Ä—É–±—ã–π –ø–æ–∏—Å–∫: –ø—Ä–æ–π–¥—ë–º—Å—è –ø–æ –¥–ª–∏–Ω–µ
    let bestL=0, bestDy=1e9;
    for(let L=0; L<=coreLen; L+=8){
      const pt = pCore.getPointAtLength(L);
      const dy = Math.abs(pt.y-yy);
      if(dy<bestDy){bestDy=dy; bestL=L;}
    }
    return pCore.getPointAtLength(bestL);
  });

  // —É–∑–ª—ã-–∏–∫–æ–Ω–∫–∏
  gMods.innerHTML='';
  points.forEach((pt,i)=>{
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('class','module'); g.setAttribute('id',`mod-${STAGES[i].id}`);
    g.setAttribute('transform',`translate(${pt.x},${pt.y})`);
    g.innerHTML = icon(STAGES[i].icon);
    gMods.appendChild(g);
  });
}

/* ===== –°–ï–ö–¶–ò–ò (—Å–ª–∞–π–¥—ã), –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –º–∏–Ω–∏–∫–∞—Ä—Ç–∞ ===== */
function buildSlides(){
  flow.innerHTML=''; miniNav.innerHTML='';
  sections = STAGES.map((s,i)=>{
    const sec=document.createElement('section');
    sec.className='stage';
    sec.id=`stage-${s.id}`;

    // –∫–∞—Ä—Ç–æ—á–∫–∞: —á–µ—Ä–µ–¥—É–µ–º —Å—Ç–æ—Ä–æ–Ω—ã
    const side = (i%2===0)? 'stage-right':'stage-left';
    const card = document.createElement('div');
    card.className=`card ${side}`;
    card.innerHTML = `
      <div class="tag">${s.tag}${s.id==='as'?' ¬∑ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ':''}</div>
      <h3>${s.title}</h3>
      <p>${s.text}</p>
    `;
    sec.appendChild(card);
    flow.appendChild(sec);

    // –º–∏–Ω–∏–∫–∞—Ä—Ç–∞
    const a=document.createElement('a');
    a.href=`#stage-${s.id}`;
    a.innerHTML=`<span class="dot"></span> ${s.tag} ${s.title}`;
    a.addEventListener('click',e=>{
      e.preventDefault();
      sec.scrollIntoView({behavior:'smooth', block:'start'});
    });
    miniNav.appendChild(a);

    return sec;
  });

  // –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ —Å–µ–∫—Ü–∏–∏ –≤–æ –≤—å—é–ø–æ—Ä—Ç
  if(ioCards) ioCards.disconnect();
  ioCards = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      const card = e.target.querySelector('.card');
      if(!card) return;
      if(e.isIntersecting) card.classList.add('show');
      else card.classList.remove('show');
    });
  }, {threshold:.55});
  sections.forEach(s=>ioCards.observe(s));
}

/* ===== –õ–û–ì–ò–ö–ê –ü–ï–†–ï–õ–Å–¢–û–í: –∫–∞–ø–ª—è + –ø–æ–≤–æ—Ä–æ—Ç —Ç—Ä—É–±—ã + –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —É–∑–ª–∞/–º–∏–Ω–∏–∫–∞—Ä—Ç—ã ===== */
function onScroll(){
  // –≤—ã—á–∏—Å–ª–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏: –∫–∞–∫–æ–π –∏–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–≤–∏–Ω—É–ª–∏—Å—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
  const vh = innerHeight || 800;
  // –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞
  const topY = window.scrollY || document.documentElement.scrollTop;

  // –Ω–∞–π–¥—ë–º –±–ª–∏–∂–∞–π—à—É—é —Å–µ–∫—Ü–∏—é
  let idx=0, local=0;
  for(let i=0;i<sections.length;i++){
    const r=sections[i].getBoundingClientRect();
    const y = r.top; // –æ—Ç–Ω–æ—Å.–≤—å—é–ø–æ—Ä—Ç–∞
    if(Math.abs(y) < vh/2){ idx=i; local = (vh/2 - y)/(vh); break; }
    // fallback: –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è
    if(i===sections.length-1 && y<vh/2){ idx=i; local = 1; }
  }
  local = Math.max(0, Math.min(1, local)); // 0..1

  // –ø–æ–∑–∏—Ü–∏—è –∫–∞–ø–ª–∏: –º–µ–∂–¥—É —Ç–æ—á–∫–æ–π idx –∏ idx+1
  const a = points[idx];
  const b = points[Math.min(points.length-1, idx+1)];
  const lerp = (u,v,t)=> u+(v-u)*t;
  const x = lerp(a.x, b.x, local);
  const y = lerp(a.y, b.y, local);
  drop.setAttribute('transform', `translate(${x},${y})`);

  // –ø–æ–≤–æ—Ä–æ—Ç —Ç—Ä—É–±—ã: –ª—ë–≥–∫–∏–π –Ω–∞–∫–ª–æ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω–¥–µ–∫—Å–∞ (–¥–∏–Ω–∞–º–∏–∫–∞ –±–µ–∑ —Ö–∞–æ—Å–∞)
  const tilt = ( (idx%2? -1:1) * 2.2 ) + (local-0.5)*1.6; // –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
  pipeWrap.style.transform = `rotate(${tilt}deg)`;

  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É–∑–ª–∞
  document.querySelectorAll('.module').forEach((m,i)=>m.classList.toggle('active', i===idx));
  // –º–∏–Ω–∏–∫–∞—Ä—Ç–∞
  const links = miniNav.querySelectorAll('a'); links.forEach(a=>a.classList.remove('active')); if(links[idx]) links[idx].classList.add('active');
}

/* ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===== */
function init(){
  buildPipe();
  buildSlides();
  // –¥–µ—Ä–Ω–µ–º onScroll –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ layout
  requestAnimationFrame(onScroll);
}

init();
addEventListener('scroll', onScroll, {passive:true});
addEventListener('resize', ()=>{ init(); }, {passive:true});

/* ===== –£—Å–∫–æ—Ä–µ–Ω–∏–µ UX: –µ—Å–ª–∏ –∫–æ–ª–µ—Å–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —á—É—Ç—å –¥–≤–∏–Ω—É–ª–∏ ‚Äî –¥–æ—Å–∫—Ä–æ–ª–ª–∏—Ç—å –¥–æ —Å–Ω–∞–ø–∞ =====
   –ù–µ–∂–Ω–æ: –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Ç–æ–ª—å–∫–æ –ø–æ–º–æ–≥–∞–µ–º, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è ‚Äú–º–µ–∂–¥—É‚Äù */
let snapTimer=null;
addEventListener('scroll', ()=>{
  clearTimeout(snapTimer);
  snapTimer=setTimeout(()=>{
    // –Ω–∞–π–¥—ë–º —Å–µ–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –±–ª–∏–∂–µ –∫ –≤–µ—Ä—Ö—É
    let best=null, bestAbs=1e9;
    sections.forEach(sec=>{
      const dy = Math.abs(sec.getBoundingClientRect().top);
      if(dy<bestAbs){bestAbs=dy; best=sec;}
    });
    if(bestAbs<140 && best) best.scrollIntoView({behavior:'smooth', block:'start'});
  }, 90);
}, {passive:true});
</script>
</body>
</html>
