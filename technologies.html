<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Технологии — Fresh Systems</title>
<meta name="color-scheme" content="dark" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap&subset=cyrillic" rel="stylesheet">
<link rel="stylesheet" href="styles.css" />
<link rel="preload" as="video" href="images/water-bg.mp4" type="video/mp4">
<link rel="preload" as="image" href="images/hero-water.jpg">

<style>
/* ——— ЛОКАЛЬНЫЕ АКЦЕНТЫ СТРАНИЦЫ ——— */
:root{
  --glass: rgba(160,230,255,.20);
  --panel-bg: rgba(255,255,255,.055);
  --panel-br: rgba(255,255,255,.10);
  --cyan:#7dd3fc;
}

/* фон-видео наследуется из styles.css; для мобильных — постер */
body.no-video .bg-video{display:none}

/* фиксированная труба: всегда на экране */
.pipe-overlay{
  position:fixed; inset:0; z-index:1; pointer-events:none;
  /* чуть над водным видео и под контентом */
}
.overlay-svg{width:100%; height:100%; display:block}

/* стеклянная труба */
#olPath{
  stroke: rgba(220,245,255,.18); stroke-width:24; fill:none;
  stroke-linecap:round; stroke-linejoin:round;
  filter: drop-shadow(0 0 12px rgba(125,211,252,.28));
}
#olCore{
  stroke: url(#coreGrad); stroke-width:13; fill:none;
  stroke-linecap:round; stroke-linejoin:round;
  filter: blur(.2px) drop-shadow(0 0 10px rgba(125,211,252,.45));
}

/* капля */
#olDrop{ filter: drop-shadow(0 0 10px rgba(116,210,255,.9)); }
#olDrop .body{
  fill:url(#dropGrad); stroke:#e6fbff; stroke-width:.8;
}

/* контентный слой поверх трубы */
.pipe-page{ position:relative; z-index:2; padding-top:56px }
.container-narrow{ max-width:1100px; margin:0 auto; padding:0 18px }

/* сетка: слева мини-карта, справа панельки-узлы */
.pipe-grid{ display:grid; grid-template-columns: 250px 1fr; gap:22px }
@media (max-width:1024px){ .pipe-grid{ grid-template-columns:1fr } }

/* мини-карта */
.toc{
  position:sticky; top:88px; align-self:flex-start;
  background:var(--panel-bg); border:1px solid var(--panel-br);
  border-radius:14px; padding:12px; backdrop-filter: blur(8px);
}
.toc h3{ margin:4px 0 8px; font-size:13px; color:#a9defc; letter-spacing:.08em; text-transform:uppercase }
.toc a{ display:flex; gap:8px; align-items:center; padding:8px 10px; border-radius:10px; color:#e6f3ff; font-weight:600; text-decoration:none }
.toc a .dot{ width:8px; height:8px; border-radius:50%; background:var(--cyan); box-shadow:0 0 8px var(--cyan) }
.toc a.active{ background:rgba(56,189,248,.14) }
.toc .hint{ margin-top:6px; color:#97a6b8; font-size:12px }

/* моб. шторка списка стадий */
.toc-toggle{ display:none }
@media (max-width:1024px){ .toc{display:none} .toc-toggle{display:inline-flex;margin-top:10px} }
.toc-sheet{
  position:fixed; left:16px; right:16px; bottom:16px; max-height:60vh; overflow:auto;
  background:rgba(11,16,32,.96); border:1px solid var(--panel-br); border-radius:16px; padding:12px;
  display:none; z-index:50; backdrop-filter: blur(8px);
}
.toc-sheet.open{ display:block }

/* панели-узлы */
.node{ margin:90vh 0 } /* крупные секции: каждая «проламывается» трубой */
.node-inner{
  max-width:620px;
  background:var(--panel-bg); border:1px solid var(--panel-br);
  border-radius:16px; padding:14px; backdrop-filter: blur(8px);
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.node .tag{
  display:inline-flex; align-items:center; gap:8px;
  background:rgba(56,189,248,.14); color:#cfefff; border:1px solid rgba(56,189,248,.28);
  padding:4px 10px; border-radius:999px; font-weight:700; letter-spacing:.03em; margin-bottom:6px;
}
.node h3{ margin:4px 0 6px; font-size:20px }
.node p{ margin:0; color:#dbe9f6; font-size:15px; line-height:1.55 }
.node details{ margin-top:8px }
.node summary{ cursor:pointer; list-style:none; color:#cfe9f8; font-weight:600 }
.node summary::marker, .node summary::-webkit-details-marker{ display:none }
.node .tech{
  margin-top:8px; border:1px dashed rgba(125,211,252,.35);
  border-radius:12px; padding:10px 12px; color:#d7e7f4; font-size:14px;
  background:rgba(125,211,252,.06);
}

/* 3D-иллюстрации (лёгкие «шаржи») */
.illus{ height:70px; margin-bottom:8px; display:flex; align-items:center; gap:10px }
.cyl{
  width:68px; height:40px; border-radius:28px/16px;
  background: linear-gradient(180deg,#dfe5ea,#a8b5c5 60%,#7f8ca0);
  box-shadow: inset 0 2px 8px rgba(0,0,0,.25), 0 6px 14px rgba(0,0,0,.25);
}
.pump{
  width:62px; height:38px; border-radius:8px;
  background: linear-gradient(180deg,#b7c7d8,#7f8ea5);
  box-shadow: inset 0 2px 8px rgba(0,0,0,.25), 0 6px 14px rgba(0,0,0,.25);
  position:relative;
}
.pump::after{
  content:""; position:absolute; right:-14px; top:8px; width:14px; height:20px; border-radius:6px;
  background: linear-gradient(180deg,#e2edf6,#94a7bc);
}

/* финальный стакан — остаётся внутри последней секции */
.glass{
  width:56px;height:78px;border-radius:8px;margin:12px 0 0;
  border:2px solid rgba(200,230,255,.7);
  background:linear-gradient(180deg,rgba(160,230,255,.10),rgba(160,230,255,.16));
  position:relative; overflow:hidden;
}
.fill{ position:absolute; left:0; right:0; bottom:0; height:0%;
  background:linear-gradient(180deg,rgba(116,210,255,.5),rgba(116,210,255,.9)); transition:height .6s ease }
.taste{
  position:absolute; inset:-30px; border-radius:16px; pointer-events:none; opacity:0;
  background:radial-gradient(60px 30px at 50% 60%, rgba(124,249,210,.35), rgba(117,210,255,.00) 60%),
             radial-gradient(40px 24px at 30% 50%, rgba(181,255,122,.30), rgba(117,210,255,.00) 60%),
             radial-gradient(40px 24px at 70% 40%, rgba(181,255,122,.20), rgba(117,210,255,.00) 60%);
  filter: blur(10px); transition: opacity .8s ease;
}

/* плавные появления */
.reveal{opacity:0; transform:translateY(18px); transition:.5s ease}
.reveal.show{opacity:1; transform:none}

/* линк без подчеркивания */
a{text-decoration:none}
</style>
</head>
<body class="no-video">

<!-- фон как на главной -->
<video id="bgVideo" class="bg-video" autoplay muted loop playsinline preload="auto" poster="images/hero-water.jpg">
  <source src="images/water-bg.mp4" type="video/mp4" />
</video>
<div class="overlay"></div>

<!-- фиксированная труба + капля -->
<div class="pipe-overlay" aria-hidden="true">
  <svg class="overlay-svg" id="ol" viewBox="0 0 1200 800" preserveAspectRatio="xMidYMid slice">
    <defs>
      <linearGradient id="coreGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="rgba(220,255,255,.95)"/>
        <stop offset="70%" stop-color="rgba(116,210,255,.65)"/>
        <stop offset="100%" stop-color="rgba(116,210,255,.40)"/>
      </linearGradient>
      <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="60%" stop-color="#cfffff"/>
        <stop offset="100%" stop-color="#7dd3fc"/>
      </radialGradient>
    </defs>

    <!-- Зигзаг в пределах 1 экрана (труба фиксирована) -->
    <path id="olPath" d="
      M 120 120
      C 420 120, 780 140, 1080 220
      S 780 380, 420 460
      S 120 620, 540 700
    "/>
    <path id="olCore" d="
      M 120 120
      C 420 120, 780 140, 1080 220
      S 780 380, 420 460
      S 120 620, 540 700
    "/>

    <!-- Светящаяся капля (двигаем по пути скроллом) -->
    <g id="olDrop" transform="translate(120,120)">
      <ellipse class="body" cx="0" cy="0" rx="11" ry="15"/>
      <circle cx="2" cy="-6" r="3" fill="#fff" opacity=".85"/>
    </g>
  </svg>
</div>

<header class="site-header">
  <a class="brand" href="index.html" aria-label="На главную">FS</a>
  <nav class="top-nav" aria-label="Основное меню">
    <a href="technologies.html" class="active">Технологии</a>
    <a href="sanpin.html">СанПиН</a>
    <a href="taste.html">Почему вода вкусная</a>
    <a href="services.html">Услуги</a>
    <a href="contacts.html">Контакты</a>
  </nav>
  <button class="menu-toggle" id="menuBtn" aria-label="Меню" aria-expanded="false"><span></span></button>
</header>
<nav class="mobile-drawer" id="drawer" hidden aria-label="Мобильное меню">
  <a href="technologies.html" class="active">Технологии</a>
  <a href="sanpin.html">СанПиН</a>
  <a href="taste.html">Почему вода вкусная</a>
  <a href="services.html">Услуги</a>
  <a href="contacts.html">Контакты</a>
</nav>

<section class="pipe-page">
  <div class="container-narrow">
    <h1 class="h1">Путь воды: от ХВС до стакана</h1>
    <p class="sub">Капля двигается по «стеклянной трубе» синхронно со скроллом. Узлы — справа, с кратким описанием и «Подробнее».</p>
    <button class="btn ghost toc-toggle" id="tocBtn">Список стадий</button>
  </div>

  <div class="container-narrow pipe-grid">
    <!-- мини-карта -->
    <aside class="toc" id="tocDesk">
      <h3>Стадии</h3>
      <nav id="tocNav"></nav>
      <div class="hint">Подсветка следует за каплей</div>
    </aside>

    <!-- шторка для мобилы -->
    <div class="toc-sheet" id="tocSheet">
      <div class="toc" style="position:static"><h3>Стадии</h3><nav id="tocNavMobile"></nav></div>
    </div>

    <!-- узлы (контент) -->
    <div id="nodes"></div>
  </div>
</section>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="minor">© 2025 Fresh Systems</div>
    <a href="index.html" class="minor">Главная</a>
  </div>
</footer>

<script>
/* — фон-видео бережно для мобилы — */
(function(){
  const isMobile = matchMedia('(max-width: 768px)').matches;
  const v = document.getElementById('bgVideo');
  if(!v) return;
  const ok=()=>{ document.body.classList.remove('no-video'); v.play?.().catch(()=>{}); };
  if(isMobile){
    document.body.classList.add('mobile-bg');
    v.pause?.(); v.removeAttribute('src'); v.load();
  }else{
    v.addEventListener('loadeddata', ok, {once:true});
    v.addEventListener('canplay', ok, {once:true});
    setTimeout(()=>{ if(v.readyState>=2) ok(); }, 1500);
  }
})();

/* — мобильное меню (клик + тач) — */
(function(){
  const btn = document.getElementById('menuBtn');
  const drawer = document.getElementById('drawer');
  if(!btn || !drawer) return;
  const toggle=(open)=>{
    if(open===undefined) open=!drawer.classList.contains('open');
    drawer.classList.toggle('open', open);
    drawer.hidden=!open;
    btn.setAttribute('aria-expanded', String(open));
    document.body.classList.toggle('mobile-menu-open', open);
  };
  const h=(e)=>{ e.preventDefault(); toggle(); };
  btn.addEventListener('click',h,{passive:false});
  btn.addEventListener('touchstart',h,{passive:false});
  const closeOutside=(e)=>{
    if(!drawer.classList.contains('open')) return;
    if(!drawer.contains(e.target) && !btn.contains(e.target)) toggle(false);
  };
  document.addEventListener('click',closeOutside);
  document.addEventListener('touchstart',closeOutside,{passive:true});
})();

/* — конфиг стадий — */
const NODES = [
  { id:'hvs',  tag:'ХВС',  title:'Ввод ХВС', text:'Исходная вода на входе.', tech:['Питьевые материалы труб','Байпас/отсечки'] },
  { id:'k1',   tag:'K1',   title:'Отсечной кран', text:'Безопасное отключение узла.', tech:['Полнооткрытый проход'] },
  { id:'ok',   tag:'OK',   title:'Обратный клапан', text:'Предотвращает обратный поток.', tech:['Подбор по расходу и ΔP'] },
  { id:'f1',   tag:'F1',   title:'Грубая очистка 100 μm', text:'Песок, окалина, ржавчина.', tech:['Промывки по регламенту'], drain:true },
  { id:'f2',   tag:'F2',   title:'Тонкая очистка 5 μm', text:'Базовая ступень PP melt-blown.', tech:['Замена по ΔP/сроку'] },
  { id:'f3',   tag:'F3',   title:'Угольный фильтр', text:'Адсорбция органики, запахов.', tech:['Для загрузочного — промывки'], drain:true },
  { id:'hd',   tag:'HD',   title:'Насос высокого давления', text:'Создаёт напор для NF.', tech:['Увязка расход/напор','Шумо/виброизоляция'], type:'pump' },
  { id:'as',   tag:'AS',   title:'Дозирование антисиланта (опц.)', text:'Защита мембран от отложений.', tech:['Доза по анализу воды'], optional:true },
  { id:'nf',   tag:'NF',   title:'Нанофильтрация', text:'Пермеат → далее; Концентрат → дренаж.', tech:['Контроль проводимости','Воздушный зазор на сливе'], drain:true },
  { id:'min',  tag:'MIN',  title:'Минерализатор Ca/Mg', text:'Настройка вкуса и TDS.', tech:['Контроль загрузки; целевой TDS'] },
  { id:'uv',   tag:'UV',   title:'УФ-обеззараживание', text:'Финишная биобезопасность.', tech:['Замена лампы; чистка кварца'] },
  { id:'tank', tag:'БАК',  title:'Бак чистой воды', text:'Резерв и сглаживание пиков.', tech:['Объём по пикам и времени восстановления'] },
  { id:'pump', tag:'PUMP', title:'Насос подачи', text:'Подача в питьевые стояки.', tech:['Давление/расход под сеть'] },
  { id:'tap',  tag:'💧',   title:'Потребитель', text:'Кухни, фонтанчики — чистая вода.', tech:['См. «Почему вода вкусная»'], final:true },
];

/* — генерация узлов и мини-карты — */
(function build(){
  const nodesWrap = document.getElementById('nodes');
  const toc = document.getElementById('tocNav');
  const tocM = document.getElementById('tocNavMobile');

  NODES.forEach((n,idx)=>{
    const node = document.createElement('section');
    node.className='node reveal';
    node.id = 'node-'+n.id;

    const ill = (n.type==='pump')
      ? '<div class="pump" aria-hidden="true"></div>'
      : '<div class="cyl" aria-hidden="true"></div>';

    node.innerHTML = `
      <div class="node-inner">
        <span class="tag">${n.tag}${n.optional?' · опционально':''}</span>
        <div class="illus">${ill}<h3 style="margin:0 0 0 6px">${n.title}</h3></div>
        <p>${n.text}</p>
        ${n.drain?'<p style="color:#9fdfff;margin-top:6px">Ответвление: Дренаж → воронка (возд. зазор) → канализация</p>':''}
        ${n.final?`
          <div style="display:flex;align-items:flex-end; gap:18px; margin-top:10px">
            <div style="width:70px;height:54px;border-radius:10px;background:linear-gradient(180deg,#dbe6f0,#9fb0c4);box-shadow:inset 0 2px 8px rgba(0,0,0,.25)"></div>
            <div class="glass"><div class="fill" id="fill"></div><div class="taste" id="taste"></div></div>
          </div>
        `:''}
        <details><summary>Подробнее</summary>
          <div class="tech"><strong>Технически:</strong><ul style="margin:6px 0 0 18px">${n.tech.map(t=>`<li>${t}</li>`).join('')}</ul></div>
        </details>
      </div>`;
    nodesWrap.appendChild(node);

    const a = document.createElement('a');
    a.href = '#node-'+n.id;
    a.innerHTML = `<span class="dot"></span> ${n.tag} ${n.title}`;
    toc?.appendChild(a.cloneNode(true));
    tocM?.appendChild(a);
  });
})();

/* — капля двигается по фиксированному пути в зависимости от прогресса прокрутки документа — */
(function droplet(){
  const path = document.getElementById('olPath');
  const drop = document.getElementById('olDrop');
  if(!path || !drop) return;

  const total = path.getTotalLength();
  const fill = document.getElementById('fill');
  const taste = document.getElementById('taste');

  const tocLinks = Array.from(document.querySelectorAll('#tocNav a, #tocNavMobile a'));
  const sections = Array.from(document.querySelectorAll('.node'));

  let ticking=false;
  const getScrollProgress=()=>{
    const doc = document.documentElement;
    const scrollTop = doc.scrollTop || document.body.scrollTop;
    const docH = doc.scrollHeight - window.innerHeight;
    return docH>0 ? Math.min(1, Math.max(0, scrollTop / docH)) : 0;
  };

  const update=()=>{
    const p = getScrollProgress();
    const len = p*(total-6);
    const pt = path.getPointAtLength(len);
    drop.setAttribute('transform',`translate(${pt.x},${pt.y})`);

    // актив в мини-карте
    let active = 0;
    for(let i=0;i<sections.length;i++){
      const r = sections[i].getBoundingClientRect();
      if(r.top < innerHeight*0.45) active = i;
    }
    const id = '#'+sections[active].id;
    tocLinks.forEach(a=>a.classList.toggle('active', a.getAttribute('href')===id));

    // финальный вкус
    if(fill && taste){
      const last = sections[sections.length-1].getBoundingClientRect();
      const vh = innerHeight;
      const f = 1 - Math.min(1, Math.max(0, last.top/vh));
      fill.style.height = (f*100)+'%';
      taste.style.opacity = f>0.95 ? 1 : 0;
    }

    // появления
    sections.forEach(s=>{
      if(s.classList.contains('show')) return;
      const r = s.getBoundingClientRect();
      if(r.top < innerHeight*0.8) s.classList.add('show');
    });

    ticking=false;
  };

  const onScroll=()=>{ if(!ticking){ ticking=true; requestAnimationFrame(update); } };
  window.addEventListener('scroll', onScroll, {passive:true});
  window.addEventListener('resize', onScroll, {passive:true});
  update();
})();

/* — клики по мини-карте — */
document.getElementById('tocDesk')?.addEventListener('click', (e)=>{
  const a = e.target.closest('a'); if(!a) return;
  e.preventDefault(); document.querySelector(a.getAttribute('href'))?.scrollIntoView({behavior:'smooth', block:'center'});
});
document.getElementById('tocSheet')?.addEventListener('click', (e)=>{
  const a = e.target.closest('a'); if(!a) return;
  e.preventDefault(); document.querySelector(a.getAttribute('href'))?.scrollIntoView({behavior:'smooth', block:'center'});
  document.getElementById('tocSheet').classList.remove('open');
});
document.getElementById('tocBtn')?.addEventListener('click', ()=> document.getElementById('tocSheet').classList.toggle('open'));
</script>
</body>
</html>
