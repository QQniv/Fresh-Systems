<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî Fresh Systems</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap&subset=cyrillic" rel="stylesheet">
<link rel="stylesheet" href="styles.css" />
<style>
:root{
  --panel-bg: rgba(255,255,255,.06);
  --panel-br: rgba(255,255,255,.12);
  --cyan: #7dd3fc;
}
body{overflow-x:hidden}

/* ===== –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç—Ä—É–±–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ ===== */
.pipe-overlay{position:fixed; inset:0; z-index:1; pointer-events:none}
.overlay-svg{width:100%; height:100%; display:block}

/* —Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è —Ç—Ä—É–±–∞ */
#pipeOuter{stroke:rgba(210,240,255,.18); stroke-width:26; fill:none; stroke-linejoin:round; stroke-linecap:round; filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}
#pipeCore {stroke:url(#coreGrad); stroke-width:15;  fill:none; stroke-linejoin:round; stroke-linecap:round; filter:drop-shadow(0 0 10px rgba(125,211,252,.45))}

/* –º–æ–¥—É–ª–∏ (—Ñ–∏–ª—å—Ç—Ä—ã) */
.module rect{fill:rgba(12,18,32,.78); stroke:rgba(140,200,255,.38); stroke-width:1.2; rx:10; ry:10}
.module line{stroke:rgba(140,200,255,.88); stroke-width:2}

/* –∫–∞–ø–ª—è: —Ä–∞–∑–º–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –º–µ–Ω—å—à–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –¥–∏–∞–º–µ—Ç—Ä–∞ */
#drop{filter: drop-shadow(0 0 10px rgba(116,210,255,.85))}
#drop .b{fill:url(#dropGrad); stroke:#e6fbff; stroke-width:.8}

/* ===== –ö–æ–Ω—Ç–µ–Ω—Ç ===== */
.pipe-page{position:relative; z-index:2; padding-top:64px}
.container{max-width:1160px; margin:0 auto; padding:0 18px}
.grid{display:grid; grid-template-columns:280px 1fr; gap:22px}
@media (max-width:1024px){.grid{grid-template-columns:1fr}}

.toc{position:sticky; top:86px; align-self:flex-start; background:var(--panel-bg); border:1px solid var(--panel-br); border-radius:14px; padding:12px; backdrop-filter: blur(8px)}
.toc h3{margin:4px 0 8px; font-size:13px; color:#a9defc; letter-spacing:.08em; text-transform:uppercase}
.toc a{display:flex; gap:8px; align-items:center; padding:8px 10px; border-radius:10px; color:#e6f3ff; font-weight:600; text-decoration:none}
.toc a .dot{width:8px; height:8px; border-radius:50%; background:var(--cyan); box-shadow:0 0 8px var(--cyan)}
.toc a.active{background:rgba(56,189,248,.14)}

.node{min-height:100vh; display:flex; align-items:center}
.node-inner{max-width:620px; background:var(--panel-bg); border:1px solid var(--panel-br); border-radius:16px; padding:14px; backdrop-filter: blur(8px); box-shadow:0 10px 30px rgba(0,0,0,.25)}
.tag{display:inline-flex; align-items:center; gap:8px; background:rgba(56,189,248,.14); color:#cfefff; border:1px solid rgba(56,189,248,.28); padding:4px 10px; border-radius:999px; font-weight:700; letter-spacing:.03em; margin-bottom:6px}
.node h3{margin:4px 0 6px; font-size:20px}
.node p{margin:0; color:#dbe9f6; font-size:15px; line-height:1.55}
details{margin-top:8px}
summary{cursor:pointer; list-style:none; color:#cfe9f8; font-weight:600}
summary::marker, summary::-webkit-details-marker{display:none}

.reveal{opacity:0; transform:translateY(18px); transition:.5s ease}
.reveal.show{opacity:1; transform:none}

/* —Å—Ç–∞–∫–∞–Ω */
.glass{width:58px; height:82px; border-radius:8px; border:2px solid rgba(200,230,255,.7); background:linear-gradient(180deg,rgba(160,230,255,.08),rgba(160,230,255,.14)); position:relative; overflow:hidden; margin-top:10px}
.fill{position:absolute; left:0; right:0; bottom:0; height:0%; background:linear-gradient(180deg,rgba(116,210,255,.5),rgba(116,210,255,.9)); transition:height .6s ease}
.taste{position:absolute; inset:-26px; border-radius:16px; pointer-events:none; opacity:0; background:
  radial-gradient(60px 30px at 50% 60%, rgba(124,249,210,.35), rgba(117,210,255,0) 60%),
  radial-gradient(40px 24px at 30% 50%, rgba(181,255,122,.30), rgba(117,210,255,0) 60%),
  radial-gradient(40px 24px at 70% 40%, rgba(181,255,122,.20), rgba(117,210,255,0) 60%);
  filter: blur(10px); transition: opacity .8s ease}
</style>
</head>
<body>

<!-- —Ñ–æ–Ω –∫–∞–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π -->
<video class="bg-video" autoplay muted loop playsinline poster="images/hero-water.jpg">
  <source src="images/water-bg.mp4" type="video/mp4" />
</video>
<div class="overlay"></div>

<!-- ===== –§–ò–ö–°. –¢–†–£–ë–ê + –ú–û–î–£–õ–ò + –ö–ê–ü–õ–Ø (—Å –º–∞—Å–∫–æ–π —Ç—Ä—É–±—ã) ===== -->
<div class="pipe-overlay" aria-hidden="true">
  <svg class="overlay-svg" id="pipeSvg" viewBox="0 0 1200 800" preserveAspectRatio="none">
    <defs>
      <linearGradient id="coreGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="rgba(230,255,255,.95)"/>
        <stop offset="70%" stop-color="rgba(116,210,255,.65)"/>
        <stop offset="100%" stop-color="rgba(116,210,255,.40)"/>
      </linearGradient>
      <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="60%" stop-color="#eaffff"/>
        <stop offset="100%" stop-color="#7dd3fc"/>
      </radialGradient>
      <!-- –ú–∞—Å–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫–∞–Ω–∞–ª–∞: –∫–∞–ø–ª—è –ù–ï –≤—ã–π–¥–µ—Ç –∑–∞ —Ç—Ä—É–±—É -->
      <mask id="pipeMask">
        <rect x="0" y="0" width="1200" height="800" fill="black"/>
        <path id="maskCore" d="" stroke="white" stroke-width="15" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </mask>
    </defs>

    <path id="pipeOuter" d=""/>
    <path id="pipeCore"  d=""/>
    <g id="modules"></g>

    <!-- –∫–∞–ø–ª—è –ø–æ–¥ –º–∞—Å–∫–æ–π -->
    <g id="drop" mask="url(#pipeMask)" transform="translate(0,0)">
      <ellipse class="b" cx="0" cy="0" rx="10" ry="14"/>
      <circle cx="2" cy="-5" r="3" fill="#fff" opacity=".85"/>
    </g>
  </svg>
</div>

<header class="site-header">
  <a class="brand" href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é">FS</a>
  <nav class="top-nav" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é">
    <a href="technologies.html" class="active">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a>
    <a href="sanpin.html">–°–∞–Ω–ü–∏–ù</a>
    <a href="taste.html">–ü–æ—á–µ–º—É –≤–æ–¥–∞ –≤–∫—É—Å–Ω–∞—è</a>
    <a href="services.html">–£—Å–ª—É–≥–∏</a>
    <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
  </nav>
  <button class="menu-toggle" id="menuBtn" aria-label="–ú–µ–Ω—é" aria-expanded="false"><span></span></button>
</header>
<nav class="mobile-drawer" id="drawer" hidden aria-label="–ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é">
  <a href="technologies.html" class="active">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a>
  <a href="sanpin.html">–°–∞–Ω–ü–∏–ù</a>
  <a href="taste.html">–ü–æ—á–µ–º—É –≤–æ–¥–∞ –≤–∫—É—Å–Ω–∞—è</a>
  <a href="services.html">–£—Å–ª—É–≥–∏</a>
  <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
</nav>

<section class="pipe-page">
  <div class="container">
    <h1 class="h1">–ü—É—Ç—å –≤–æ–¥—ã: –æ—Ç –•–í–° –¥–æ —Å—Ç–∞–∫–∞–Ω–∞</h1>
    <p class="sub">–¢—Ä—É–±–∞ –∏–∑–≥–∏–±–∞–µ—Ç—Å—è –Ω–∞ 90¬∞ —É –∫—Ä–∞—ë–≤ —ç–∫—Ä–∞–Ω–∞. –ö–∞–ø–ª—è –¥–≤–∏–∂–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä—É–±—ã –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–π —É–∑–µ–ª.</p>
  </div>

  <div class="container grid">
    <aside class="toc" id="toc">
      <h3>–°—Ç–∞–¥–∏–∏</h3>
      <nav id="tocNav"></nav>
    </aside>
    <div id="nodes"></div>
  </div>
</section>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="minor">¬© 2025 Fresh Systems</div>
    <a href="index.html" class="minor">–ì–ª–∞–≤–Ω–∞—è</a>
  </div>
</footer>

<script>
/* ‚Äî‚Äî‚Äî –£–∑–ª—ã ‚Äî‚Äî‚Äî */
const NODES = [
  { id:'hvs',  tag:'–•–í–°',  title:'–í–≤–æ–¥ –•–í–°', text:'–ò—Å—Ö–æ–¥–Ω–∞—è –≤–æ–¥–∞ –Ω–∞ –≤—Ö–æ–¥–µ.' },
  { id:'k1',   tag:'K1',   title:'–û—Ç—Å–µ—á–Ω–æ–π –∫—Ä–∞–Ω', text:'–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —É–∑–ª–∞.' },
  { id:'ok',   tag:'OK',   title:'–û–±—Ä–∞—Ç–Ω—ã–π –∫–ª–∞–ø–∞–Ω', text:'–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ç–æ–∫.' },
  { id:'f1',   tag:'F1',   title:'–ì—Ä—É–±–∞—è –æ—á–∏—Å—Ç–∫–∞ 100 Œºm', text:'–ü–µ—Å–æ–∫, —Ä–∂–∞–≤—á–∏–Ω–∞, –æ–∫–∞–ª–∏–Ω–∞.', drain:true },
  { id:'f2',   tag:'F2',   title:'–¢–æ–Ω–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ 5 Œºm', text:'–ë–∞–∑–æ–≤–∞—è —Å—Ç—É–ø–µ–Ω—å PP melt-blown.' },
  { id:'f3',   tag:'F3',   title:'–£–≥–æ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä', text:'–ê–¥—Å–æ—Ä–±—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∫–∏ –∏ –∑–∞–ø–∞—Ö–æ–≤.', drain:true },
  { id:'hd',   tag:'HD',   title:'–ù–∞—Å–æ—Å –≤—ã—Å–æ–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è', text:'–°–æ–∑–¥–∞—ë—Ç –Ω–∞–ø–æ—Ä –¥–ª—è NF.' },
  { id:'as',   tag:'AS',   title:'–ê–Ω—Ç–∏—Å–∏–ª–∞–Ω—Ç (–æ–ø—Ü.)', text:'–ó–∞—â–∏—Ç–∞ –º–µ–º–±—Ä–∞–Ω –æ—Ç –æ—Ç–ª–æ–∂–µ–Ω–∏–π.', optional:true },
  { id:'nf',   tag:'NF',   title:'–ù–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è', text:'–ü–µ—Ä–º–µ–∞—Ç ‚Üí –¥–∞–ª–µ–µ; –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç ‚Üí –¥—Ä–µ–Ω–∞–∂.', drain:true },
  { id:'min',  tag:'MIN',  title:'–ú–∏–Ω–µ—Ä–∞–ª–∏–∑–∞—Ç–æ—Ä Ca/Mg', text:'–§–æ—Ä–º–∏—Ä—É–µ—Ç –≤–∫—É—Å –∏ —Ü–µ–ª–µ–≤–æ–π TDS.' },
  { id:'uv',   tag:'UV',   title:'–£–§-–æ–±–µ–∑–∑–∞—Ä–∞–∂–∏–≤–∞–Ω–∏–µ', text:'–§–∏–Ω–∏—à–Ω–∞—è –±–∏–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.' },
  { id:'tank', tag:'–ë–ê–ö',  title:'–ë–∞–∫ —á–∏—Å—Ç–æ–π –≤–æ–¥—ã', text:'–†–µ–∑–µ—Ä–≤ –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–∏–∫–æ–≤.' },
  { id:'pump', tag:'PUMP', title:'–ù–∞—Å–æ—Å –ø–æ–¥–∞—á–∏', text:'–ü–æ–¥–∞—á–∞ –≤ —Å—Ç–æ—è–∫–∏.' },
  { id:'tap',  tag:'üíß',   title:'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å', text:'–ö—É—Ö–Ω–∏, —Ñ–æ–Ω—Ç–∞–Ω—á–∏–∫–∏ ‚Äî —á–∏—Å—Ç–∞—è –≤–æ–¥–∞.', final:true }
];

/* ‚Äî‚Äî‚Äî –ú–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—ã ‚Äî‚Äî‚Äî */
(function(){
  const btn = document.getElementById('menuBtn');
  const d = document.getElementById('drawer');
  if(!btn||!d) return;
  const t=(o)=>{ if(o===undefined) o=!d.classList.contains('open');
    d.classList.toggle('open',o); d.hidden=!o; btn.setAttribute('aria-expanded', String(o));
    document.body.classList.toggle('mobile-menu-open',o); };
  const h=e=>{e.preventDefault(); t();};
  btn.addEventListener('click',h,{passive:false}); btn.addEventListener('touchstart',h,{passive:false});
  document.addEventListener('click',e=>{ if(!d.classList.contains('open')) return; if(!d.contains(e.target)&&!btn.contains(e.target)) t(false);});
})();

/* ‚Äî‚Äî‚Äî –ö–æ–Ω—Ç–µ–Ω—Ç —É–∑–ª–æ–≤ + –º–∏–Ω–∏-–∫–∞—Ä—Ç–∞ ‚Äî‚Äî‚Äî */
(function buildContent(){
  const wrap = document.getElementById('nodes');
  const toc = document.getElementById('tocNav');
  NODES.forEach(n=>{
    const s=document.createElement('section'); s.className='node reveal'; s.id='node-'+n.id;
    s.innerHTML=`
      <div class="node-inner">
        <span class="tag">${n.tag}${n.optional?' ¬∑ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ':''}</span>
        <h3>${n.title}</h3>
        <p>${n.text}</p>
        ${n.drain?'<p style="color:#9fdfff;margin-top:6px">–û—Ç–≤–µ—Ç–≤–ª–µ–Ω–∏–µ: –¥—Ä–µ–Ω–∞–∂ ‚Üí –≤–æ—Ä–æ–Ω–∫–∞ (–≤–æ–∑–¥. –∑–∞–∑–æ—Ä) ‚Üí –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</p>':''}
        ${n.final?`
          <div style="display:flex;align-items:flex-end; gap:18px; margin-top:10px">
            <div style="width:70px;height:54px;border-radius:10px;background:linear-gradient(180deg,#dbe6f0,#9fb0c4);box-shadow:inset 0 2px 8px rgba(0,0,0,.25)"></div>
            <div class="glass"><div class="fill" id="fill"></div><div class="taste" id="taste"></div></div>
          </div>`:''}
        <details><summary>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary>
          <p style="margin-top:8px;color:#d7e7f4">–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Å–µ—Ä–≤–∏—Å –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤–æ–¥—ã –∏ —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –¥–µ–±–∏—Ç–∞.</p>
        </details>
      </div>`;
    wrap.appendChild(s);
    const a=document.createElement('a'); a.href='#node-'+n.id; a.innerHTML=`<span class="dot"></span> ${n.tag} ${n.title}`;
    toc.appendChild(a);
  });
})();

/* ‚Äî‚Äî‚Äî –ì–µ–æ–º–µ—Ç—Ä–∏—è —Ç—Ä—É–±—ã: 90¬∞ –∑–∏–≥–∑–∞–≥ + –º–æ–¥—É–ª–∏, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ ‚Äî‚Äî‚Äî */
(function buildPipe(){
  const svg   = document.getElementById('pipeSvg');
  const outer = document.getElementById('pipeOuter');
  const core  = document.getElementById('pipeCore');
  const maskC = document.getElementById('maskCore');
  const modsG = document.getElementById('modules');

  function makePath(){
    const w = svg.clientWidth;
    const h = svg.clientHeight;

    // –†–∞–∑–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞/–º–æ–±–∏–ª—ã
    const isMobile = matchMedia('(max-width: 768px)').matches;
    const marginX = isMobile ? Math.max(40, w*0.05) : Math.max(80, w*0.06);
    const startY  = 120;
    const bottomPad = 100;

    const left  = marginX;
    const right = w - marginX;

    // —à–∞–≥ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∏—Å–ª–∞ —É–∑–ª–æ–≤ –∏ –≤—ã—Å–æ—Ç—ã –≤—å—é–ø–æ—Ä—Ç–∞
    const turns = NODES.length;
    const usableH = h - startY - bottomPad;
    const stepY   = Math.max(80, usableH / (turns*0.9));

    // —Å—Ç—Ä–æ–∏–º –≤–µ—Ä—à–∏–Ω—ã ¬´–ø–æ–ª–æ–∫¬ª
    const pts = [];
    let dirRight = true;
    let x = left, y = startY;
    pts.push([x,y]);
    for(let i=0;i<turns;i++){
      x = dirRight ? right : left;   // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ö–æ–¥ –¥–æ –∫—Ä–∞—è (90¬∞)
      pts.push([x,y]);
      y += stepY;                    // –ø–æ—Ç–æ–º –≤–Ω–∏–∑
      pts.push([x,y]);
      dirRight = !dirRight;
    }

    const r = 14; // –Ω–µ–±–æ–ª—å—à–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–∞
    let d = `M ${pts[0][0]} ${pts[0][1]}`;
    for(let i=1;i<pts.length;i++){
      const [px,py]=pts[i-1], [cx,cy]=pts[i];
      if(py===cy){ // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
        const sign = cx>px ? 1 : -1;
        d += ` L ${cx - sign*r} ${cy}`;
        if(i+1<pts.length) d += ` Q ${cx} ${cy} ${cx} ${cy + r}`; else d += ` L ${cx} ${cy}`;
      }else{       // –≤–µ—Ä—Ç–∏–∫–∞–ª—å
        const sign = cy>py ? 1 : -1;
        d += ` L ${cx} ${cy - sign*r}`;
        if(i+1<pts.length){
          const [nx]=pts[i+1];
          d += ` Q ${cx} ${cy} ${cx + (nx>cx ? r : -r)} ${cy}`;
        }else d += ` L ${cx} ${cy}`;
      }
    }

    outer.setAttribute('d', d);
    core.setAttribute('d',  d);
    maskC.setAttribute('d', d); // –º–∞—Å–∫–∞ = –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—É—Ç—å

    // ===== –º–æ–¥—É–ª–∏ –ø–æ–≤–µ—Ä—Ö —Ç—Ä—É–±—ã, –ø–æ–ø–µ—Ä—ë–∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è =====
    modsG.innerHTML='';
    const len = outer.getTotalLength();
    const modW = 56, modH = 30; // –±–∞–∑–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã ¬´–∫–æ—Ä–æ–±–∫–∏¬ª
    NODES.forEach((n,i)=>{
      const t = (i+0.5)/(NODES.length+0.5);
      const L = t*len;
      const pt = outer.getPointAtLength(L);
      const prev = outer.getPointAtLength(Math.max(0, L-1));
      const horiz = Math.abs(pt.y - prev.y) < Math.abs(pt.x - prev.x);

      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','module');

      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');

      if(horiz){
        rect.setAttribute('x', pt.x - modW/2);
        rect.setAttribute('y', pt.y - modH/2);
        rect.setAttribute('width', modW);
        rect.setAttribute('height', modH);
        line.setAttribute('x1', pt.x - modW/2 + 8);
        line.setAttribute('x2', pt.x + modW/2 - 8);
        line.setAttribute('y1', pt.y);
        line.setAttribute('y2', pt.y);
      }else{
        rect.setAttribute('x', pt.x - modH/2);
        rect.setAttribute('y', pt.y - modW/2);
        rect.setAttribute('width', modH);
        rect.setAttribute('height', modW);
        line.setAttribute('x1', pt.x);
        line.setAttribute('x2', pt.x);
        line.setAttribute('y1', pt.y - modW/2 + 8);
        line.setAttribute('y2', pt.y + modW/2 - 8);
      }
      g.appendChild(rect); g.appendChild(line);
      modsG.appendChild(g);
    });

    return { path: outer, length: len };
  }

  let geom = makePath();
  window.addEventListener('resize', ()=>{ geom = makePath(); update(); }, {passive:true});

  /* ‚Äî –∫–∞–ø–ª—è –ø–æ —Å–∫—Ä–æ–ª–ª—É ‚Äî */
  const drop  = document.getElementById('drop');
  const fill  = document.getElementById('fill');
  const taste = document.getElementById('taste');
  const sections = Array.from(document.querySelectorAll('.node'));
  const tocLinks = Array.from(document.querySelectorAll('#tocNav a'));

  function progress(){
    const doc = document.documentElement;
    const st  = doc.scrollTop || document.body.scrollTop;
    const dh  = doc.scrollHeight - innerHeight;
    return dh>0 ? Math.min(1, Math.max(0, st/dh)) : 0;
  }

  function update(){
    const p = progress();
    const L = p*(geom.length-2);
    const pt= geom.path.getPointAtLength(L);
    drop.setAttribute('transform',`translate(${pt.x},${pt.y})`);

    // –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è
    let idx=0; for(let i=0;i<sections.length;i++){ const r=sections[i].getBoundingClientRect(); if(r.top<innerHeight*0.45) idx=i; }
    const id = '#'+sections[idx].id;
    tocLinks.forEach(a=>a.classList.toggle('active', a.getAttribute('href')===id));

    // –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
    sections.forEach(s=>{ if(s.classList.contains('show')) return; const r=s.getBoundingClientRect(); if(r.top<innerHeight*0.8) s.classList.add('show'); });

    // –≤–∫—É—Å
    if(fill && taste){
      const last = sections[sections.length-1].getBoundingClientRect();
      const vh = innerHeight;
      const f = 1 - Math.min(1, Math.max(0, last.top/vh));
      fill.style.height = (f*100)+'%';
      taste.style.opacity = f>0.95 ? 1 : 0;
    }
  }

  window.addEventListener('scroll', update, {passive:true});
  window.addEventListener('resize', update, {passive:true});
  update();
})();

/* ‚Äî –∫–ª–∏–∫–∏ –ø–æ –º–∏–Ω–∏-–∫–∞—Ä—Ç–µ ‚Äî */
(function(){
  const toc = document.getElementById('toc');
  const nav = document.getElementById('tocNav');
  NODES.forEach(n=>{
    const a=document.createElement('a'); a.href='#node-'+n.id; a.innerHTML=`<span class="dot"></span> ${n.tag} ${n.title}`;
    nav.appendChild(a);
  });
  toc?.addEventListener('click',e=>{
    const a=e.target.closest('a'); if(!a) return;
    e.preventDefault(); document.querySelector(a.getAttribute('href'))?.scrollIntoView({behavior:'smooth', block:'center'});
  });
})();
</script>
</body>
</html>
