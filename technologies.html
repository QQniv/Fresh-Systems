<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî Fresh Systems</title>

<link rel="stylesheet" href="styles.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap&subset=cyrillic" rel="stylesheet"/>

<style>
:root{
  --ink:#eaf6ff; --muted:#bcd2e7;
  --panel:rgba(255,255,255,.07); --panel-br:rgba(255,255,255,.12);
  --cyan:#7dd3fc; --good:#8cf9cc;
}
body{overflow-x:hidden}

.page-tech{position:relative; z-index:1; padding-top:84px}
.container{max-width:1100px; margin:0 auto; padding:0 20px}
.h1{font:900 clamp(32px,6vw,56px)/1.05 Inter,system-ui; color:var(--ink); margin:0 0 8px}
.lead{color:var(--muted); font-size:clamp(14px,2.4vw,18px); margin:0 0 24px}

/* –°—Ü–µ–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞: —Ç—Ä—É–±–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Å–ª–æ–π –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–≤–µ—Ä—Ö */
.scene{position:relative; min-height:2200px; margin:8px 0 80px}
#pipeSVG{position:absolute; inset:0; width:100%; height:100%; display:block}
#notesLayer{position:absolute; inset:0; pointer-events:none; z-index:3} /* –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∞–º–∏ pointer-events:auto */

/* –¢—Ä—É–±–∞ ‚Äî –ª–∞–∫–æ–Ω–∏—á–Ω–∞—è —Å—Ç–µ–∫–ª–æ/–º–µ—Ç–∞–ª–ª */
.pipe-shadow{stroke:rgba(0,0,0,.40); stroke-width:38; fill:none; stroke-linecap:round; filter:url(#shadowSoft)}
.pipe-glass {stroke:url(#glassStroke); stroke-width:34; fill:none; stroke-linecap:round; filter:url(#specLight)}
.pipe-core  {stroke:url(#coreGrad);   stroke-width:18; fill:none; stroke-linecap:round; filter:drop-shadow(0 0 10px rgba(116,210,255,.55))}
.pipe-flow  {stroke:rgba(185,245,255,.95); stroke-width:6; fill:none; stroke-linecap:round; stroke-dasharray:0 22 8 110; animation:flow 3s linear infinite; opacity:.95}
@keyframes flow{to{stroke-dashoffset:-160}}

/* –ú–∞—Å–∫–∞ –¥–ª—è –∫–∞–ø–ª–∏ (—á—É—Ç—å —à–∏—Ä–µ –∫–æ—Ä—ã) */
.mask-stroke{stroke:#fff; stroke-width:26; fill:none; stroke-linecap:round}

/* –û–î–ù–ê –∫–∞–ø–ª—è, —Å–∏–Ω—Ö—Ä–æ–Ω —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º */
.drop{filter:drop-shadow(0 0 14px rgba(116,210,255,1))}
.drop .aura{fill:rgba(115,220,255,.38); transform-origin:center; animation:pulse 1.8s ease-in-out infinite}
.drop .body{fill:url(#dropGrad); stroke:#e6fbff; stroke-width:1.2}
.drop .glint{fill:#fff; opacity:.95}
@keyframes pulse{0%,100%{transform:scale(.92); opacity:.65} 50%{transform:scale(1.06); opacity:1}}

/* –£–∑–ª—ã –Ω–∞ —Ç—Ä—É–±–µ */
.module{filter:drop-shadow(0 8px 18px rgba(0,0,0,.28))}
.mod-plate{fill:rgba(9,14,22,.84); stroke:rgba(170,215,255,.6); stroke-width:1.6; rx:10}
.mod-icon{stroke:#dff3ff; stroke-width:2.2; fill:none; stroke-linecap:round; stroke-linejoin:round}
.module.active .mod-plate{stroke:var(--good)}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–ø—Ä–æ—Ç–∏–≤ —É–∑–ª–∞ */
.note{
  position:absolute; width:min(420px,42vw);
  background:var(--panel); border:1px solid var(--panel-br); border-radius:14px; padding:12px 14px;
  backdrop-filter:blur(8px); color:#e9f6ff; box-shadow:0 12px 28px rgba(0,0,0,.26);
  opacity:0; transform:translateY(16px); transition:.45s ease; pointer-events:auto; z-index:4
}
.note.show{opacity:1; transform:none}
.note .tag{display:inline-flex; gap:8px; align-items:center; padding:4px 10px; border-radius:999px;
  border:1px solid rgba(125,211,252,.35); background:rgba(125,211,252,.14); color:#dff6ff; font-weight:700; margin-bottom:6px}
.note h3{margin:4px 0 6px; font:700 17px/1.3 Inter; color:#eef9ff}
.note p{margin:0; color:#cfe3f5; font-size:15px; line-height:1.55}

/* –¢–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è, —Å–æ–µ–¥–∏–Ω—è—é—â–∞—è —É–∑–µ–ª –∏ –∫–∞—Ä—Ç–æ—á–∫—É */
.connector{position:absolute; height:2px; background:linear-gradient(90deg,#9fdcff,#4db9f7); opacity:.55; z-index:3}

/* –ù–∞ –º–æ–±–∏–ª–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ–¥ —É–∑–ª–æ–º */
@media (max-width:768px){
  .note{width:calc(100% - 40px); left:20px !important; transform:translateY(10px)}
  .connector{display:none}
}

/* Respect user settings */
@media (prefers-reduced-motion: reduce){
  .pipe-flow{animation:none}
  .drop .aura{animation:none}
  .note{transition:none}
}
</style>
</head>
<body>
<video class="bg-video" autoplay muted loop playsinline poster="images/hero-water.jpg">
  <source src="images/water-bg.mp4" type="video/mp4"/>
</video>
<div class="overlay"></div>

<header class="site-header">
  <a class="brand" href="index.html" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é">FS</a>
  <nav class="top-nav" aria-label="–û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é">
    <a href="technologies.html" class="active">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a>
    <a href="sanpin.html">–°–∞–Ω–ü–∏–ù</a>
    <a href="taste.html">–ü–æ—á–µ–º—É –≤–æ–¥–∞ –≤–∫—É—Å–Ω–∞—è</a>
    <a href="services.html">–£—Å–ª—É–≥–∏</a>
    <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
  </nav>
  <button class="menu-toggle" id="menuBtn" aria-label="–ú–µ–Ω—é" aria-expanded="false"><span></span></button>
</header>
<nav class="mobile-drawer" id="drawer" hidden aria-label="–ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é">
  <a href="technologies.html" class="active">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</a>
  <a href="sanpin.html">–°–∞–Ω–ü–∏–ù</a>
  <a href="taste.html">–ü–æ—á–µ–º—É –≤–æ–¥–∞ –≤–∫—É—Å–Ω–∞—è</a>
  <a href="services.html">–£—Å–ª—É–≥–∏</a>
  <a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
</nav>

<main class="page-tech container">
  <h1 class="h1">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h1>
  <p class="lead">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ç—Ä—É–±–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Ç—å –≤–æ–¥—ã. –°–∫—Ä–æ–ª–ª –≤–µ–¥—ë—Ç –∫–∞–ø–ª—é –ø–æ —Ç—Ä—É–±–µ; –Ω–∞–ø—Ä–æ—Ç–∏–≤ –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ –≤—Å–ø—ã—Ö–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –ø—Ä–æ—Å—Ç—ã–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º.</p>

  <section class="scene" id="scene">
    <svg id="pipeSVG" viewBox="0 0 560 2200" preserveAspectRatio="none" role="img" aria-label="–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ç—Ä—É–±–∞ —Å —É–∑–ª–∞–º–∏">
      <defs>
        <linearGradient id="glassStroke" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%"   stop-color="rgba(240,248,255,.75)"/>
          <stop offset="50%"  stop-color="rgba(170,205,235,.38)"/>
          <stop offset="100%" stop-color="rgba(40,60,80,.36)"/>
        </linearGradient>
        <linearGradient id="coreGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%"   stop-color="rgba(230,255,255,.98)"/>
          <stop offset="70%"  stop-color="rgba(116,210,255,.78)"/>
          <stop offset="100%" stop-color="rgba(116,210,255,.48)"/>
        </linearGradient>
        <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
          <stop offset="0%"   stop-color="#ffffff"/>
          <stop offset="55%"  stop-color="#eaffff"/>
          <stop offset="100%" stop-color="#7dd3fc"/>
        </radialGradient>
        <filter id="shadowSoft" x="-30%" y="-30%" width="160%" height="160%"><feGaussianBlur stdDeviation="3"/></filter>
        <filter id="specLight" x="-20%" y="-20%" width="140%" height="140%">
          <feSpecularLighting surfaceScale="2.2" specularConstant="0.6" specularExponent="18" lighting-color="#e6f7ff">
            <fePointLight x="-120" y="-200" z="100"/>
          </feSpecularLighting>
          <feComposite operator="in" in2="SourceGraphic"/>
        </filter>
        <mask id="tubeMask">
          <rect x="0" y="0" width="560" height="2200" fill="black"/>
          <path id="maskPath" class="mask-stroke" d=""/>
        </mask>
      </defs>

      <!-- —Ç—Ä—É–±–∞ (–º—è–≥–∫–∏–µ S-–∏–∑–≥–∏–±—ã –¥–ª—è ¬´–∂–∏–≤–æ—Å—Ç–∏¬ª, –Ω–æ –±–µ–∑ —Ö–∞–æ—Å–∞) -->
      <path id="pipeShadow" class="pipe-shadow" d=""/>
      <path id="pipeGlass"  class="pipe-glass"  d=""/>
      <path id="pipeCore"   class="pipe-core"   d=""/>
      <path id="pipeFlow"   class="pipe-flow"   d="" mask="url(#tubeMask)"/>

      <!-- —É–∑–ª—ã -->
      <g id="modules"></g>

      <!-- –∫–∞–ø–ª—è (–æ–¥–Ω–∞) -->
      <g id="drop" class="drop" transform="translate(280,120)" mask="url(#tubeMask)">
        <ellipse class="aura" cx="0" cy="0" rx="22" ry="28"/>
        <ellipse class="body" cx="0" cy="0" rx="14" ry="20"/>
        <circle  class="glint" cx="3" cy="-8" r="3.5"/>
      </g>
    </svg>

    <!-- —Å–ª–æ–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤ (–ø–æ–≤–µ—Ä—Ö SVG) -->
    <div id="notesLayer"></div>
  </section>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="minor">¬© 2025 Fresh Systems</div>
    <a href="index.html" class="minor">–ì–ª–∞–≤–Ω–∞—è</a>
  </div>
</footer>

<script>
/* –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
(()=>{const b=document.getElementById('menuBtn'),d=document.getElementById('drawer');if(!b||!d)return;
const t=o=>{if(o===undefined)o=!d.classList.contains('open');d.classList.toggle('open',o);d.hidden=!o;b.setAttribute('aria-expanded',String(o));document.body.classList.toggle('mobile-menu-open',o)};
const h=e=>{e.preventDefault();t()};b.addEventListener('click',h,{passive:false});b.addEventListener('touchstart',h,{passive:false});
document.addEventListener('click',e=>{if(!d.classList.contains('open'))return;if(!d.contains(e.target)&&!b.contains(e.target))t(false);});})();

/* —É–∑–ª—ã ‚Äî –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ */
const STAGES = [
  {id:'hvs', tag:'–•–í–°', title:'–í–≤–æ–¥ —Ö–æ–ª–æ–¥–Ω–æ–π –≤–æ–¥—ã', text:'–ò—Å—Ö–æ–¥–Ω–∞—è –≤–æ–¥–∞ –Ω–∞ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É.'},
  {id:'f1',  tag:'F1',  title:'–ì—Ä—É–±–∞—è –æ—á–∏—Å—Ç–∫–∞ 100 Œºm', text:'–£–±–∏—Ä–∞–µ—Ç –ø–µ—Å–æ–∫ –∏ —Ä–∂–∞–≤—á–∏–Ω—É. –ü—Ä–æ–º—ã–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä.', icon:'grid'},
  {id:'f2',  tag:'F2',  title:'–¢–æ–Ω–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ 5 Œºm',  text:'–ö–∞—Ä—Ç—Ä–∏–¥–∂ PP: –º–µ–ª–∫–∏–µ –≤–∑–≤–µ—Å–∏.', icon:'cartridge'},
  {id:'f3',  tag:'F3',  title:'–£–≥–æ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä',      text:'–ê–¥—Å–æ—Ä–±—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∫–∏ –∏ –∑–∞–ø–∞—Ö–æ–≤.', icon:'carbon'},
  {id:'hd',  tag:'HD',  title:'–ù–∞—Å–æ—Å –≤—ã—Å–æ–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è', text:'–°–æ–∑–¥–∞—ë—Ç –¥–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –Ω–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞.', icon:'pump'},
  {id:'as',  tag:'AS',  title:'–ê–Ω—Ç–∏—Å–∏–ª–∞–Ω—Ç (–æ–ø—Ü.)',    text:'–ó–∞—â–∏—â–∞–µ—Ç –º–µ–º–±—Ä–∞–Ω—É –æ—Ç –æ—Ç–ª–æ–∂–µ–Ω–∏–π.', icon:'dose'},
  {id:'nf',  tag:'NF',  title:'–ù–∞–Ω–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è',       text:'–ú–µ–º–±—Ä–∞–Ω–∞: –ø–µ—Ä–º–µ–∞—Ç ‚Äî –≤ –ø–∏—Ç—å–µ–≤—É—é –∑–æ–Ω—É, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç ‚Äî –≤ –¥—Ä–µ–Ω–∞–∂.', icon:'membrane'},
  {id:'min', tag:'MIN', title:'–ú–∏–Ω–µ—Ä–∞–ª–∏–∑–∞—Ç–æ—Ä Ca/Mg',  text:'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∫—É—Å: Ca/Mg –¥–æ —Ü–µ–ª–µ–≤–æ–≥–æ TDS.', icon:'min'},
  {id:'uv',  tag:'UV',  title:'–£–§-–æ–±–µ–∑–∑–∞—Ä–∞–∂–∏–≤–∞–Ω–∏–µ',   text:'–§–∏–Ω–∏—à–Ω–∞—è –±–∏–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–°–∞–Ω–ü–∏–ù).', icon:'uv'},
  {id:'tap', tag:'üíß',  title:'–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å',          text:'–ö—Ä–∞–Ω ‚Üí —Å—Ç–∞–∫–∞–Ω —Å —á–∏—Å—Ç–æ–π –≤–æ–¥–æ–π.', icon:'tap', final:true}
];

const scene    = document.getElementById('scene');
const svg      = document.getElementById('pipeSVG');
const pShadow  = document.getElementById('pipeShadow');
const pGlass   = document.getElementById('pipeGlass');
const pCore    = document.getElementById('pipeCore');
const pFlow    = document.getElementById('pipeFlow');
const maskPath = document.getElementById('maskPath');
const gMods    = document.getElementById('modules');
const drop     = document.getElementById('drop');
const notesLay = document.getElementById('notesLayer');

let coreLen = 0;
let points  = [];

/* –∏–∫–æ–Ω–∫–∏ —É–∑–ª–æ–≤ (–ª–∞–∫–æ–Ω–∏—á–Ω–æ) */
function icon(kind){
  switch(kind){
    case 'grid':      return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-36 -10 h72 v20 h-72 z M-18 -10 v20 M18 -10 v20 M-36 0 h72"/>`;
    case 'cartridge': return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><ellipse class="mod-icon" cx="0" cy="0" rx="30" ry="12"/>`;
    case 'carbon':    return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><rect class="mod-icon" x="-30" y="-10" width="60" height="20" rx="6"/>`;
    case 'pump':      return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><rect class="mod-icon" x="-20" y="-8" width="24" height="16" rx="3"/><rect class="mod-icon" x="8" y="-6" width="18" height="12" rx="3"/>`;
    case 'dose':      return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-8 -12 v24 M8 -12 v24 M-18 0 h36"/>`;
    case 'membrane':  return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-30 -8 h60 M-30 -2 h60 M-30 4 h60"/>`;
    case 'min':       return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><rect class="mod-icon" x="-12" y="-8" width="24" height="16" rx="3"/>`;
    case 'uv':        return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-28 0 h56 M-16 -8 h32 M-16 8 h32"/>`;
    case 'tap':       return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-16 0 h32 M12 0 v12 M0 14 v-8"/>`;
    default:          return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/>`;
  }
}

/* —Å—Ç—Ä–æ–∏–º —Ç—Ä—É–±—É (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è + –º—è–≥–∫–∏–µ –∏–∑–≥–∏–±—ã), —Å—á–∏—Ç–∞–µ–º —Ç–æ—á–∫–∏ —É–∑–ª–æ–≤ */
function buildPipe(){
  const VBW=560, VBH=2200, cx=VBW/2, top=120, bottom=VBH-120;
  const bends=6, span=(bottom-top)/bends;
  let d=`M ${cx} ${top}`;
  for(let i=0;i<bends;i++){
    const y1=top+i*span, y2=y1+span, x1=cx+(i%2?14:-14), x2=cx+(i%2?-14:14);
    d+=` C ${x1} ${y1+span*.35}, ${x2} ${y1+span*.65}, ${cx} ${y2}`;
  }
  [pShadow,pGlass,pCore,pFlow,maskPath].forEach(p=>p.setAttribute('d', d));
  coreLen = pCore.getTotalLength();

  gMods.innerHTML='';
  const offsets=STAGES.map((_,i)=>(i/(STAGES.length-1))*coreLen);
  points = offsets.map(L=>pCore.getPointAtLength(L));
  points.forEach((pt,i)=>{
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('class','module'); g.setAttribute('id',`mod-${STAGES[i].id}`);
    g.setAttribute('transform',`translate(${pt.x},${pt.y})`);
    g.innerHTML=icon(STAGES[i].icon);
    gMods.appendChild(g);
  });
}

/* —Å–æ–∑–¥–∞—ë–º/—Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—Ä–æ–≥–æ –Ω–∞–ø—Ä–æ—Ç–∏–≤ —É–∑–ª–æ–≤ (—Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ –ø–æ –æ—á–µ—Ä–µ–¥–∏) */
function layoutNotes(){
  notesLay.innerHTML='';
  const isMobile = matchMedia('(max-width:768px)').matches;
  const svgRect  = svg.getBoundingClientRect();
  const sceneTop = svgRect.top + window.scrollY;

  const pageLeft = 20, pageRight = window.innerWidth - 20;
  const columnGap = 18;

  STAGES.forEach((s,i)=>{
    const pt = points[i]; if(!pt) return;

    // 1) –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç–æ—á–∫—É, –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ª–æ–π (—Å–Ω–∞—á–∞–ª–∞ ¬´–±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç¬ª, –ø–æ—Ç–æ–º –∑–∞–º–µ—Ä–∏–º –≤—ã—Å–æ—Ç—É)
    const note = document.createElement('div');
    note.className='note'; note.id=`note-${s.id}`;
    note.innerHTML=`<div class="tag">${s.tag}${s.id==='as'?' ¬∑ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ':''}</div><h3>${s.title}</h3><p>${s.text}</p>`;
    notesLay.appendChild(note);

    // 2) –í—ã—á–∏—Å–ª—è–µ–º –∏–¥–µ–∞–ª—å–Ω—É—é –≤–µ—Ä—Ç–∏–∫–∞–ª—å ‚Äî —Å—Ç—Ä–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É —É–∑–ª–∞ (–ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –∑–Ω–∞–µ–º –≤—ã—Å–æ—Ç—É)
    const nodeY = sceneTop + pt.y;
    const cardW = Math.min(420, window.innerWidth*0.42);

    if(isMobile){
      // –º–æ–±–∞–π–ª: –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ–¥ —É–∑–ª–æ–º
      const h = note.offsetHeight;
      const top = nodeY - h/2;
      note.style.left = '20px';
      note.style.right= '20px';
      note.style.top  = Math.max(sceneTop+10, top) + 'px';
    } else {
      // –¥–µ—Å–∫—Ç–æ–ø: —á–µ—Ä–µ–¥—É–µ–º —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Å–∏ —Ç—Ä—É–±—ã
      const preferRight = i%2===0;
      const nodeX = svgRect.left + pt.x;

      let left = preferRight ? (nodeX + columnGap) : (nodeX - cardW - columnGap);
      left = Math.max(pageLeft, Math.min(left, pageRight - cardW));
      const h = note.offsetHeight;
      let top = nodeY - h/2;                  // —Ü–µ–Ω—Ç—Ä-–≤-—Ü–µ–Ω—Ç—Ä
      const sceneBottom = svgRect.bottom + window.scrollY - 10;
      if(top < sceneTop+10) top = sceneTop+10; // –Ω–µ —É–ø–æ–ª–∑–∞—Ç—å –≤—ã—à–µ
      if(top + h > sceneBottom) top = sceneBottom - h; // –∏ –Ω–∏–∂–µ

      note.style.left = left + 'px';
      note.style.top  = top  + 'px';

      // 3) –¢–æ–Ω–∫–∏–π –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –æ—Ç –∫—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫ —É–∑–ª—É
      const conn = document.createElement('div');
      conn.className='connector';
      const yCenter = top + Math.min(28, h*0.35);
      const xStart  = preferRight ? left : (left + cardW);
      const xEnd    = preferRight ? (nodeX - 10) : (nodeX + 10);
      conn.style.top  = yCenter + 'px';
      conn.style.left = Math.min(xStart, xEnd) + 'px';
      conn.style.width= Math.abs(xEnd - xStart) + 'px';
      notesLay.appendChild(conn);
    }
  });

  // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
  const io=new IntersectionObserver((entries)=>{entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('show'); });},{rootMargin:'0px 0px -10% 0px',threshold:.12});
  notesLay.querySelectorAll('.note').forEach(n=>io.observe(n));
}

/* –¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–ø–ª–∏ —Å—Ç—Ä–æ–≥–æ —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º */
function onScroll(){
  const r=scene.getBoundingClientRect(), vh=innerHeight;
  const total=r.height+vh, p=Math.min(total, Math.max(0, vh - r.top))/total; // 0..1
  const L=p*coreLen; const pt=pCore.getPointAtLength(L||.0001);
  drop.setAttribute('transform',`translate(${pt.x},${pt.y})`);

  // –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–π –º–æ–¥—É–ª—å
  const idx=Math.max(0,Math.min(STAGES.length-1,Math.round(p*(STAGES.length-1))));
  document.querySelectorAll('.module').forEach((m,i)=>m.classList.toggle('active', i===idx));
}

/* –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ (—á—Ç–æ–±—ã —Å–æ–≤–ø–∞–ª–∏ —Ü–µ–Ω—Ç—Ä—ã —É –ª—é–±–æ–π —à–∏—Ä–∏–Ω—ã/–≤—ã—Å–æ—Ç—ã) */
function rebuild(){
  buildPipe();
  layoutNotes();
  onScroll();
}

/* init */
rebuild();
addEventListener('scroll', onScroll, {passive:true});
addEventListener('resize', rebuild, {passive:true});

/* ==== –∏–∫–æ–Ω–∫–∏ —É–∑–ª–æ–≤ (–º–∏–Ω–∏–º–∞–ª) ==== */
function icon(kind){
  switch(kind){
    case 'grid':      return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-36 -10 h72 v20 h-72 z M-18 -10 v20 M18 -10 v20 M-36 0 h72"/>`;
    case 'cartridge': return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><ellipse class="mod-icon" cx="0" cy="0" rx="30" ry="12"/>`;
    case 'carbon':    return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><rect class="mod-icon" x="-30" y="-10" width="60" height="20" rx="6"/>`;
    case 'pump':      return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><rect class="mod-icon" x="-20" y="-8" width="24" height="16" rx="3"/><rect class="mod-icon" x="8" y="-6" width="18" height="12" rx="3"/>`;
    case 'dose':      return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-8 -12 v24 M8 -12 v24 M-18 0 h36"/>`;
    case 'membrane':  return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-30 -8 h60 M-30 -2 h60 M-30 4 h60"/>`;
    case 'min':       return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><rect class="mod-icon" x="-12" y="-8" width="24" height="16" rx="3"/>`;
    case 'uv':        return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-28 0 h56 M-16 -8 h32 M-16 8 h32"/>`;
    case 'tap':       return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/><path class="mod-icon" d="M-16 0 h32 M12 0 v12 M0 14 v-8"/>`;
    default:          return `<rect class="mod-plate" x="-46" y="-18" width="92" height="36" rx="10"/>`;
  }
}
</script>
</body>
</html>
